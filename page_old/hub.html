<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏®‡∏π‡∏ô‡∏¢‡πå‡πÅ‡∏•‡∏Å‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ - En-Code</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Prompt', sans-serif;
            background-color: #f0f7ff;
        }

        .gradient-bg-header {
            background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
        }

        .chat-container-wrapper {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 12rem);
            min-height: 450px;
        }

        /* ‡∏õ‡∏£‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á */
        .chat-messages {
            flex-grow: 1;
            overflow-y: auto;
        }

        .badge-glow {
            animation: glow 2s infinite alternate;
        }

        @keyframes glow {
            from {
                box-shadow: 0 0 5px -5px #3b82f6;
            }

            to {
                box-shadow: 0 0 10px 5px #3b82f6;
            }
        }

        #nav-hub {
            color: #bfdbfe;
            font-weight: 600;
            border-bottom: 2px solid #bfdbfe;
        }

        .like-btn.liked {
            color: #3b82f6;
            /* Blue when liked */
            font-weight: bold;
        }

        .like-btn {
            cursor: pointer;
            user-select: none;
        }
    </style>
</head>

<body class="min-h-screen flex flex-col">
    <!-- Common Header (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) -->
    <header class="gradient-bg-header text-white shadow-lg">
        <div class="container mx-auto px-4 py-6">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <div class="flex items-center mb-4 md:mb-0">
                    <a href="index.html" class="text-3xl font-bold flex items-center">
                        <span class="text-4xl mr-2">üå±</span>
                        <span>En-Code</span>
                    </a>
                </div>
                <nav class="flex flex-wrap items-center space-x-4 md:space-x-6" id="main-navbar">
                    <a href="index.html" id="nav-home"
                        class="hover:text-blue-200 transition nav-item-static">‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</a>
                    <a href="missions.html" id="nav-missions"
                        class="hover:text-blue-200 transition nav-item-auth">‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à</a> <!-- ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô auth -->
                    <a href="resources.html" id="nav-resources"
                        class="hover:text-blue-200 transition nav-item-auth">‡πÅ‡∏´‡∏•‡πà‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ</a> <!-- ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô auth -->
                    <a href="hub.html" id="nav-hub"
                        class="hover:text-blue-200 transition nav-item-auth">‡∏®‡∏π‡∏ô‡∏¢‡πå‡πÅ‡∏•‡∏Å‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô</a>
                    <a href="ai_assistant.html" id="nav-ai" class="hover:text-blue-200 transition nav-item-auth">AI
                        ‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢</a>
                    <a href="testing_coach.html" id="nav-coach"
                        class="hover:text-blue-200 transition nav-item-auth">‡πÇ‡∏Ñ‡πâ‡∏ä‡∏ó‡∏î‡∏™‡∏≠‡∏ö</a>
                </nav>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-grow container mx-auto px-4 py-6 flex flex-col md:flex-row gap-6">
        <!-- Sidebar -->
        <div class="w-full md:w-1/4 flex-shrink-0 space-y-6">
            <div class="bg-white rounded-lg shadow-md p-4">
                <h2 class="text-lg font-semibold text-blue-800 mb-4">‡∏´‡πâ‡∏≠‡∏á‡∏™‡∏ô‡∏ó‡∏ô‡∏≤</h2>
                <ul id="room-list" class="space-y-2">
                    <li><button data-room-id="‡∏´‡πâ‡∏≠‡∏á‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Ñ‡∏¥‡∏î‡πÄ‡∏•‡∏Ç"
                            class="room-btn w-full text-left px-4 py-2 rounded-md bg-blue-100 text-blue-800 font-medium flex items-center justify-between"><span>‡∏´‡πâ‡∏≠‡∏á‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Ñ‡∏¥‡∏î‡πÄ‡∏•‡∏Ç</span><span
                                class="bg-blue-600 text-white text-xs px-2 py-1 rounded-full">‡πÉ‡∏´‡∏°‡πà</span></button></li>
                    <li><button data-room-id="‡∏´‡πâ‡∏≠‡∏á‡∏ó‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç"
                            class="room-btn w-full text-left px-4 py-2 rounded-md hover:bg-blue-50 text-gray-700 flex items-center justify-between"><span>‡∏´‡πâ‡∏≠‡∏á‡∏ó‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç</span></button>
                    </li>
                    <li><button data-room-id="‡∏´‡πâ‡∏≠‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏Å‡∏°"
                            class="room-btn w-full text-left px-4 py-2 rounded-md hover:bg-blue-50 text-gray-700 flex items-center justify-between"><span>‡∏´‡πâ‡∏≠‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏Å‡∏°</span></button>
                    </li>
                </ul>
            </div>
            <div class="bg-white rounded-lg shadow-md p-4">
                <h2 class="text-lg font-semibold text-blue-800 mb-4">‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏°‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î (Top 10)</h2>
                <ul id="leaderboard-list" class="space-y-3">
                    <!-- Leaderboard items will be injected here -->
                    <li class="text-gray-500">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</li>
                </ul>
            </div>
        </div>

        <!-- Chat Area -->
        <div class="w-full md:w-3/4 bg-white rounded-lg shadow-md flex flex-col chat-container-wrapper">
            <div class="bg-blue-600 text-white px-6 py-3 flex justify-between items-center flex-shrink-0">
                <h2 id="chat-room-title" class="text-lg font-semibold">‡∏´‡πâ‡∏≠‡∏á‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Ñ‡∏¥‡∏î‡πÄ‡∏•‡∏Ç</h2>
                <div class="flex items-center space-x-2"><span id="online-users-count" class="text-sm">0
                        ‡∏Ñ‡∏ô‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏ô‡∏ó‡∏ô‡∏≤</span><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none"
                        viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
                    </svg></div>
            </div>
            <div id="chat-messages-area" class="chat-messages p-4 space-y-4 bg-gray-50">
                <!-- Chat messages will be injected here -->
                <p class="text-center text-gray-500">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡∏™‡∏ô‡∏ó‡∏ô‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏£‡∏Å</p>
            </div>
            <div class="bg-white p-4 border-t flex-shrink-0">
                <div class="flex space-x-2">
                    <button title="‡πÅ‡∏ô‡∏ö‡πÑ‡∏ü‡∏•‡πå" class="p-2 rounded-full bg-blue-100 text-blue-600 hover:bg-blue-200"><svg
                            xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13" />
                        </svg></button>
                    <input id="hub-message-input" type="text"
                        class="flex-grow border rounded-full px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                        placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì...">
                    <button id="hub-send-button"
                        class="px-4 py-2 bg-blue-600 text-white rounded-full hover:bg-blue-700 flex items-center"><svg
                            xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                        </svg>‡∏™‡πà‡∏á</button>
                </div>
            </div>
        </div>
    </main>

    <!-- Common Footer (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) -->
    <footer class="bg-blue-900 text-white py-10 px-4">
        <!-- ... (‡πÇ‡∏Ñ‡πâ‡∏î Footer ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) ... -->
    </footer>
    <script src="js\main.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async function () {
            const roomList = document.getElementById('room-list');
            const chatRoomTitle = document.getElementById('chat-room-title');
            const messageInput = document.getElementById('hub-message-input');
            const sendButton = document.getElementById('hub-send-button');
            const chatMessagesArea = document.getElementById('chat-messages-area');
            const leaderboardList = document.getElementById('leaderboard-list');
            let currentRoomId = "‡∏´‡πâ‡∏≠‡∏á‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Ñ‡∏¥‡∏î‡πÄ‡∏•‡∏Ç"; // Default room
            let currentUserId = null; // ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å check auth

            async function fetchCurrentUser() {
                try {
                    const response = await fetch('http://127.0.0.1:5000/check_auth_status', { credentials: 'include' });
                    if (response.ok) {
                        const data = await response.json();
                        if (data.logged_in && data.user) {
                            currentUserId = data.user.id;
                            return data.user;
                        }
                    }
                } catch (error) {
                    console.error("Error fetching current user:", error);
                }
                return null;
            }


            function displayMessage(msg) {
                if (!chatMessagesArea) return;
                const messageWrapper = document.createElement('div');
                const isCurrentUser = msg.user_id === currentUserId;
                messageWrapper.className = `flex flex-col mb-3 ${isCurrentUser ? 'items-end' : 'items-start'}`;

                const messageContent = document.createElement('div');
                messageContent.className = `flex items-start space-x-2 ${isCurrentUser ? 'flex-row-reverse' : ''}`;

                const avatarInitial = msg.username ? msg.username.charAt(0).toUpperCase() : '?';
                const avatarColor = isCurrentUser ? 'bg-blue-500' : 'bg-gray-400'; // Example colors
                const avatar = `<div class="h-8 w-8 rounded-full ${avatarColor} text-white flex items-center justify-center text-sm font-semibold flex-shrink-0">${avatarInitial}</div>`;

                const bubble = document.createElement('div');
                bubble.className = `rounded-lg p-3 shadow-sm max-w-md ${isCurrentUser ? 'bg-blue-100 text-blue-800' : 'bg-white text-gray-800'}`;

                const header = document.createElement('div');
                header.className = 'flex items-center space-x-2 mb-1';
                const timeFormatted = msg.timestamp ? new Date(msg.timestamp + " UTC").toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' }) : 'N/A';
                header.innerHTML = `<span class="font-medium">${msg.username || 'Anonymous'}</span><span class="text-xs text-gray-500">${timeFormatted} ‡∏ô.</span>`;

                const likeButton = document.createElement('span');
                likeButton.innerHTML = `üéñÔ∏è <span class="like-count">${msg.num_likes || 0}</span>`;
                likeButton.className = `like-btn text-gray-500 hover:text-blue-600 text-xs ml-2 ${msg.user_has_liked ? 'liked' : ''}`;
                likeButton.dataset.messageId = msg.id;

                if (msg.user_id !== currentUserId) { // User ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ like ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡πÑ‡∏î‡πâ
                    likeButton.addEventListener('click', () => handleLikeMessage(msg.id, likeButton));
                } else {
                    likeButton.style.cursor = 'default';
                    likeButton.classList.remove('hover:text-blue-600');
                }


                header.appendChild(likeButton);

                const p = document.createElement('p');
                p.className = "text-sm";
                p.textContent = msg.content;

                bubble.appendChild(header);
                bubble.appendChild(p);

                messageContent.innerHTML = avatar;
                messageContent.appendChild(bubble);
                messageWrapper.appendChild(messageContent);
                chatMessagesArea.appendChild(messageWrapper);
            }

            async function loadMessages(roomId) {
                if (!chatMessagesArea) return;
                chatMessagesArea.innerHTML = '<p class="text-center text-gray-500">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°...</p>';
                currentRoomId = roomId;
                if (chatRoomTitle) chatRoomTitle.textContent = roomId;
                try {
                    const response = await fetch(`http://127.0.0.1:5000/hub/messages/${roomId}`, { credentials: 'include' });
                    if (response.ok) {
                        const messages = await response.json();
                        chatMessagesArea.innerHTML = ''; // Clear loading message
                        if (messages.length === 0) {
                            chatMessagesArea.innerHTML = '<p class="text-center text-gray-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏µ‡πâ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢!</p>';
                        } else {
                            messages.forEach(displayMessage);
                        }
                        chatMessagesArea.scrollTop = chatMessagesArea.scrollHeight;
                    } else {
                        chatMessagesArea.innerHTML = '<p class="text-center text-red-500">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏î‡πâ</p>';
                        console.error("Failed to load messages:", response.status);
                    }
                } catch (error) {
                    chatMessagesArea.innerHTML = '<p class="text-center text-red-500">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</p>';
                    console.error("Error loading messages:", error);
                }
            }

            async function postMessage() {
                if (!messageInput || !currentRoomId || !currentUserId) return;
                const content = messageInput.value.trim();
                if (content === '') return;

                try {
                    const response = await fetch('http://127.0.0.1:5000/hub/messages', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify({ room_id: currentRoomId, content: content })
                    });
                    if (response.ok) {
                        const newMessage = await response.json();
                        // ‡∏ñ‡πâ‡∏≤ chatMessagesArea ‡πÅ‡∏™‡∏î‡∏á "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°" ‡πÉ‡∏´‡πâ‡∏•‡πâ‡∏≤‡∏á‡∏Å‡πà‡∏≠‡∏ô
                        if (chatMessagesArea.querySelector('p.text-center.text-gray-500')) {
                            chatMessagesArea.innerHTML = '';
                        }
                        displayMessage(newMessage); // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏á‡∏™‡πà‡∏á
                        messageInput.value = '';
                        chatMessagesArea.scrollTop = chatMessagesArea.scrollHeight;
                    } else {
                        const errorData = await response.json();
                        alert(`Error posting message: ${errorData.error || 'Unknown error'}`);
                    }
                } catch (error) {
                    console.error("Error posting message:", error);
                    alert("Failed to post message due to a network error.");
                }
            }

            async function handleLikeMessage(messageId, likeButtonElement) {
                if (!currentUserId) {
                    alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏î‡πÑ‡∏•‡∏Ñ‡πå");
                    return;
                }
                try {
                    const response = await fetch(`http://127.0.0.1:5000/hub/like_message/${messageId}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include'
                    });
                    if (response.ok) {
                        const data = await response.json();
                        const likeCountElement = likeButtonElement.querySelector('.like-count');
                        if (likeCountElement) likeCountElement.textContent = data.num_likes;
                        likeButtonElement.classList.toggle('liked', data.liked);
                        fetchLeaderboard(); // Refresh leaderboard after a like/unlike
                    } else {
                        const errorData = await response.json();
                        alert(`Error liking message: ${errorData.error || 'Unknown error'}`);
                    }
                } catch (error) {
                    console.error("Error liking message:", error);
                    alert("Failed to like message due to a network error.");
                }
            }

            async function fetchLeaderboard() {
                if (!leaderboardList) return;
                leaderboardList.innerHTML = '<li class="text-gray-500">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö...</li>';
                try {
                    const response = await fetch('http://127.0.0.1:5000/hub/leaderboard', { credentials: 'include' });
                    if (response.ok) {
                        const leaders = await response.json();
                        leaderboardList.innerHTML = ''; // Clear loading
                        if (leaders.length === 0) {
                            leaderboardList.innerHTML = '<li class="text-gray-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö</li>';
                        } else {
                            leaders.forEach((leader, index) => {
                                const li = document.createElement('li');
                                li.className = 'flex items-center justify-between text-sm';
                                li.innerHTML = `
                                <div class="flex items-center space-x-2">
                                    <span class="font-semibold text-gray-500">${index + 1}.</span>
                                    <div class="h-7 w-7 rounded-full bg-gray-300 flex items-center justify-center text-gray-600 font-bold text-xs">${leader.username.charAt(0).toUpperCase()}</div>
                                    <span>${leader.username}</span>
                                </div>
                                <div class="flex items-center space-x-1 text-yellow-500">
                                    <span class="font-medium">${leader.points}</span>
                                    <span>üéñÔ∏è</span>
                                </div>`;
                                leaderboardList.appendChild(li);
                            });
                        }
                    } else {
                        leaderboardList.innerHTML = '<li class="text-red-500">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡πÑ‡∏î‡πâ</li>';
                    }
                } catch (error) {
                    console.error("Error fetching leaderboard:", error);
                    leaderboardList.innerHTML = '<li class="text-red-500">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</li>';
                }
            }


            if (roomList) {
                const roomButtons = roomList.querySelectorAll('.room-btn');
                roomButtons.forEach(button => {
                    button.addEventListener('click', function () {
                        roomButtons.forEach(btn => {
                            btn.classList.remove('bg-blue-100', 'text-blue-800', 'font-medium');
                            btn.classList.add('hover:bg-blue-50', 'text-gray-700');
                            const badge = btn.querySelector('span:last-child.bg-blue-600'); // More specific selector for active badge
                            if (badge) {
                                badge.classList.remove('bg-blue-600', 'text-white');
                                badge.classList.add('bg-gray-200', 'text-gray-700');
                            }
                        });
                        this.classList.add('bg-blue-100', 'text-blue-800', 'font-medium');
                        this.classList.remove('hover:bg-blue-50', 'text-gray-700');
                        const activeBadge = this.querySelector('span:last-child');
                        if (activeBadge && !activeBadge.textContent.includes('‡∏´‡πâ‡∏≠‡∏á')) { // Ensure it's the count badge
                            activeBadge.classList.add('bg-blue-600', 'text-white');
                            activeBadge.classList.remove('bg-gray-200', 'text-gray-700');
                        }
                        loadMessages(this.dataset.roomId);
                    });
                });
            }

            if (sendButton && messageInput) {
                sendButton.addEventListener('click', postMessage);
                messageInput.addEventListener('keypress', function (e) { if (e.key === 'Enter') { e.preventDefault(); postMessage(); } });
            }

            // Initial Load
            async function initializeHub() {
                const user = await fetchCurrentUser();
                if (user) { // User is logged in
                    loadMessages(currentRoomId); // Load messages for the default room
                    fetchLeaderboard();
                } else {
                    // User is not logged in, redirect or show login message
                    // main.js should handle redirecting to login if this page requires auth
                    // For now, just disable chat input if not logged in
                    if (messageInput) messageInput.disabled = true;
                    if (sendButton) sendButton.disabled = true;
                    if (chatMessagesArea) chatMessagesArea.innerHTML = '<p class="text-center text-red-500">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤ <a href="login.html" class="text-blue-600 underline">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</a> ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏®‡∏π‡∏ô‡∏¢‡πå‡πÅ‡∏•‡∏Å‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ</p>';
                    if (leaderboardList) leaderboardList.innerHTML = '<li class="text-gray-500">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö</li>';

                }
            }
            initializeHub();

        });
    </script>
</body>

</html>